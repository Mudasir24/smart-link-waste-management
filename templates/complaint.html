{% extends "layout.html" %}
{% block title %}Complaint{% endblock %}
{% block main %}

<style>
        /* File upload styling */
        .file-upload-container {
            border: 2px dashed #d1d5db;
            border-radius: 0.5rem;
            position: relative;
            text-align: center;
            transition: all 0.3s ease;
        }
        .file-upload-container:hover {
            border-color: #10b981;
        }
        .file-upload-container.active {
            border-color: #10b981;
            background-color: rgba(16, 185, 129, 0.05);
        }
        .image-preview {
            max-height: 200px;
            max-width: 100%;
            margin: 0 auto;
            border-radius: 0.375rem;
            object-fit: contain;
        }
</style>

<div class="max-w-4xl mx-auto py-6 sm:px-6 lg:px-8">
        <!-- Complaint Form -->
        <div id="complaint-form-section" class="px-4 sm:px-0">
            <div class="bg-white shadow rounded-lg overflow-hidden">
                <div class="px-4 py-5 border-b border-gray-200 sm:px-6">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">Report a Waste Management Issue</h3>
                    <p class="mt-1 text-sm text-gray-500">Please provide details about the waste management issue you've encountered.</p>
                </div>
                <div class="px-4 py-5 sm:p-6">
                    <form action="/complaint" method="post" id="complaint-form" class="space-y-6" enctype="multipart/form-data">
                        <!-- Image Upload -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Upload Image
                                <span class="text-sm text-gray-500 font-normal ml-1">(Required)</span>
                            </label>
                            <div id="image-upload-container" class="file-upload-container p-6 cursor-pointer">
                                <input type="file" id="image-upload" class="hidden" accept="image/*" name="image">
                                <div id="upload-placeholder" class="flex flex-col items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-400 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                    <p class="text-sm text-gray-500">Click to upload or drag and drop</p>
                                    <p class="text-xs text-gray-400 mt-1">PNG, JPG, GIF up to 10MB</p>
                                </div>
                                <div id="image-preview-container" class="hidden mt-4">
                                    <img id="image-preview" class="image-preview" src="" alt="Preview">
                                    <button type="button" id="remove-image" class="mt-2 text-sm text-red-600 hover:text-red-800">Remove image</button>
                                </div>
                            </div>
                        </div>

                        <!-- Location Information -->
                        <div class="space-y-4">
                            <label class="block text-sm font-medium text-gray-700">
                                Location Details
                                <span class="text-sm text-gray-500 font-normal ml-1">(Required)</span>
                            </label>
                                    
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="locality" class="block text-sm font-medium text-gray-700 mb-1">Locality/Area</label>
                                    <input type="text" name="area" id="locality" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="Enter locality or area" readonly>
                                </div>
                                <div>
                                    <label for="city" class="block text-sm font-medium text-gray-700 mb-1">City</label>
                                    <input type="text" name="city" id="city" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="Enter city" readonly>
                                </div>
                            </div>
                                    
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="pincode" class="block text-sm font-medium text-gray-700 mb-1">Pincode</label>
                                    <input name="pincode" type="text" id="pincode" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="Enter pincode" readonly>
                                </div>
                                <div class="flex items-end">
                                    <button type="button" id="auto-detect-location" class="w-full bg-gray-100 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-200 transition duration-200 flex items-center justify-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
                                        </svg>
                                        Auto-detect Location
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- GPS Coordinates -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                GPS Coordinates
                            </label>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="latitude" class="block text-sm font-medium text-gray-700 mb-1">Latitude</label>
                                    <input type="text" name="latitude" id="latitude" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="Latitude" readonly="">
                                </div>
                                <div>
                                    <label for="longitude" class="block text-sm font-medium text-gray-700 mb-1">Longitude</label>
                                    <input type="text" name="longitude" id="longitude" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="Longitude" readonly="">
                                </div>
                            </div>
                            <div class="mt-2 hidden">
                                <button type="button" id="get-coordinates" class="bg-emerald-100 text-emerald-700 py-2 px-4 rounded-lg hover:bg-emerald-200 transition duration-200 flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
                                    </svg>
                                    Get Exact Coordinates
                                </button>
                            </div>
                        </div>

                        <!-- Description -->
                        <div>
                            <label for="description" class="block text-sm font-medium text-gray-700 mb-2">
                                Description
                                <span class="text-sm text-gray-500 font-normal ml-1">(Optional)</span>
                            </label>
                            <textarea name="description" id="description" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="Provide additional details about the issue..."></textarea>
                        </div>

                        <!-- Submit Button -->
                        <div class="flex justify-end">
                            <button type="submit" id="submit-complaint" class="bg-emerald-600 text-white py-2 px-6 rounded-lg hover:bg-emerald-700 transition duration-200 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                </svg>
                                Submit Complaint
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        
        // Image upload functionality
        const imageUploadContainer = document.getElementById('image-upload-container');
        const imageUploadInput = document.getElementById('image-upload');
        const uploadPlaceholder = document.getElementById('upload-placeholder');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreview = document.getElementById('image-preview');
        const removeImageButton = document.getElementById('remove-image');

        imageUploadContainer.addEventListener('click', function() {
            imageUploadInput.click();
        });

        imageUploadContainer.addEventListener('dragover', function(e) {
            e.preventDefault();
            imageUploadContainer.classList.add('active');
        });

        imageUploadContainer.addEventListener('dragleave', function() {
            imageUploadContainer.classList.remove('active');
        });

        imageUploadContainer.addEventListener('drop', function(e) {
            e.preventDefault();
            imageUploadContainer.classList.remove('active');
            
            if (e.dataTransfer.files.length) {
                imageUploadInput.files = e.dataTransfer.files;
                displayImagePreview(e.dataTransfer.files[0]);
            }
        });

        imageUploadInput.addEventListener('change', function() {
            if (this.files.length) {
                displayImagePreview(this.files[0]);
            }
        });

        removeImageButton.addEventListener('click', function(e) {
            e.stopPropagation();
            imageUploadInput.value = '';
            uploadPlaceholder.classList.remove('hidden');
            imagePreviewContainer.classList.add('hidden');
        });

        function displayImagePreview(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                imagePreview.src = e.target.result;
                uploadPlaceholder.classList.add('hidden');
                imagePreviewContainer.classList.remove('hidden');
            }
            
            reader.readAsDataURL(file);
        }

        // Geolocation functionality
        const getCoordinatesButton = document.getElementById('get-coordinates');
        const latitudeInput = document.getElementById('latitude');
        const longitudeInput = document.getElementById('longitude');
        
        getCoordinatesButton.addEventListener('click', function() {
            if (navigator.geolocation) {
                getCoordinatesButton.innerHTML = `
                    <svg class="animate-spin h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Getting coordinates...
                `;
                
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        latitudeInput.value = position.coords.latitude.toFixed(6);
                        longitudeInput.value = position.coords.longitude.toFixed(6);
                        
                        getCoordinatesButton.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
                            </svg>
                            Get Exact Coordinates
                        `;
                    },
                    function(error) {
                        alert("Error getting location: " + error.message);
                        
                        getCoordinatesButton.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
                            </svg>
                            Get Exact Coordinates
                        `;
                    }
                );
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        });

        // Auto-detect location
        const autoDetectButton = document.getElementById('auto-detect-location');
        const localityInput = document.getElementById('locality');
        const cityInput = document.getElementById('city');
        const pincodeInput = document.getElementById('pincode');
    

        autoDetectButton.addEventListener('click', function () {
            if (navigator.geolocation) {
                autoDetectButton.innerHTML = `
                    <svg class="animate-spin h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Detecting...
                `;

                navigator.geolocation.getCurrentPosition(
                    function (position) {
                        const latitude = position.coords.latitude;
                        const longitude = position.coords.longitude;

                        // Send coordinates to backend
                        fetch('/get-location', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ latitude: latitude, longitude: longitude })
                        })
                            .then(response => response.json())
                            .then(data => {
                                localityInput.value = data.neighborhood || 'Not found';
                                cityInput.value = data.municipality || 'Not found';
                                pincodeInput.value = data.postal_code || 'Not found';

                                if (latitudeInput && longitudeInput) {
                                    latitudeInput.value = latitude.toFixed(6);
                                    longitudeInput.value = longitude.toFixed(6);
                                }

                                autoDetectButton.innerHTML = `
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
                                    </svg>
                                    Auto-detect Location
                                `;
                            })
                            .catch(error => {
                                alert("Error getting location data: " + error.message);
                                autoDetectButton.innerHTML = `Try Again`;
                            });
                    },
                    function (error) {
                        alert("Error getting device location: " + error.message);
                        autoDetectButton.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
                            </svg>
                            Auto-detect Location
                        `;
                    }
                );
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        });
        
    </script>

{% endblock %}